<!DOCTYPE html>
<html lang='zh-Hans'><head>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
  <title></title>
</head><body>

<style>
body {
  margin: 0;
  padding: 0;
  line-height: 1;
  background: #606060;
}

#container {
  margin: 0 auto;
  height: 100vh;
  width: 100%;
  max-width: 111.11vh;
  position: relative;
  background: white;
  overflow: hidden;

  font-family: 'ABeeZee', 'ChillRoundF';
  line-height: 1;
  font-size: 4vh;
}

#container > div > * {
  position: absolute;
}

#container > div {
  transition: opacity 0.2s ease;
}

.maybe-hidden {
  transition: opacity 0.2s ease;
}
.hidden {
  opacity: 0 !important;
  pointer-events: none;
  cursor: auto;
}

p {
  margin: 0;
  padding: 0;
}

button {
  cursor: pointer;
  border: none;
  background: none;
  margin: 0;
  padding: 0;
}
</style>

<div id='container'>

<!-- Main viewport width = min(100vw, 111.11vh) -->

<div>
  <img src='img/fox-nn.webp' style='width: max(60%, 50vh)' id='scene-startup-foxnn-logo'>
  <style>
  #scene-startup-foxnn-logo {
    left: calc(97% - calc(max(60%, 50vh) / 2));
    top: 10%;
    transform: rotate(90deg);
    transition: left 1.5s ease, top 1.5s ease, transform 1.5s ease, opacity 0.2s ease;
  }
  #scene-startup-foxnn-logo.run {
    left: 0%;
    top: 0%;
    transform: rotate(0deg) scale(0.75);
  }
  </style>
</div>
<div id='scene-startup-1'>
  <p style='left: 5%; top: 12.5%; font-size: 10.5vh; line-height: 1.5;'>The<br>Rolling Tail<br>Headlines</p>
  <button style='width: max(60%, 50vh); height: clamp(50vh, 60vw, 66.67vh); left: calc(97% - calc(max(60%, 50vh) / 2)); top: 10%; border-radius: 50%; transform: scale(1.1); z-index: 99' id='btn-start'></button>

  <img src='img/pen.webp' style='height: 14.22%; left: 5.6%; top: 66.7%'>
  <p style='left: calc(7% + 14.22vh); top: 67.2%; font-size: 7.2vh;'>简体中文</p>
  <p style='left: calc(7% + 14.22vh); top: 75.7%; font-size: 4.8vh; opacity: 0.5'>zh-Hans</p>
  <button style='left: calc(7% + 14.22vh); top: 67.2%; width: 100vw; height: 13%' id='btn-lang'></button>
</div>
<div id='scene-startup-2' class='hidden'>
  <div style='left: 57%; width: 40%; top: 12.5%; height: 40%; font-size: 5.6vh; display: table'><p style='display: table-cell; vertical-align: middle; line-height: 1.5'>In the 22<sup>nd</sup> century, foxes are the playful super-wizards.</p></div>
  <p style='left: 5%; width: 90%; top: 62%; font-size: 4.8vh; line-height: 1.5'>Fox Newroll Network takes you around the world with our one-of-a-kind fox magic of “heads or tails”. Join us in our exploration!</p>
  <p style='left: 5%; width: 90%; top: 88%; font-size: 4.8vh; line-height: 1.5; opacity: 0.5' id='scene-startup-press' class='maybe-hidden hidden'>Loading…</p>
</div>


<div id='scene-game' class='hidden' style='transition: opacity 0.5s ease'>
  <img src='' id='scene-game-illustration'>
  <div style='background: linear-gradient(rgba(255, 255, 255, 75%) 80%, transparent 100%); height: 20%; width: 100%; top: 0; left: 0; transition: opacity 0.5s ease' id='coin-text-background-head'></div>
  <div style='background: linear-gradient(transparent 0%, rgba(255, 255, 255, 75%) 20%); height: 20%; width: 100%; top: 80%; left: 0; transition: opacity 0.5s ease' id='coin-text-background-tail'></div>
  <div id='coin-text-head'>
    <img src='img/coin-small-head.webp' style='height: 14.22vh; top: 5vh'>
    <div style='font-size: 6vh; top: 5vh; width: calc(88% - 14.22vh); height: 14.22vh; display: table'><p style='display: table-cell; vertical-align: middle' id='coin-text-content-head'>A new type of…</p></div>
  </div>
  <div id='coin-text-tail'>
    <img src='img/coin-small-tail.webp' style='height: 14.22vh; top: 0.78vh'>
    <div style='font-size: 6vh; top: 0.78vh; width: calc(88% - 14.22vh); height: 14.22vh; display: table'><p style='display: table-cell; vertical-align: middle' id='coin-text-content-tail'>Penguins have formed a…</p></div>
  </div>
  <div style='width: 55vh; height: 55vh; top: 21vh; border-radius: 50%; border: black 1vh solid; transition: opacity 0.5s ease; background: white' id='coin-flipping'>
    <img style='width: 100%; height: 100%' src='img/coin-head.webp' id='coin-flipping-head'>
    <img style='width: 100%; height: 100%' src='img/coin-tail.webp' id='coin-flipping-tail'>
  </div>
  <style>
  #scene-game-illustration {
    width: 100%; height: 100%; left: 0; top: 0; transition: opacity 0.5s ease;
    object-fit: cover;
    object-position: center;
  }
  #coin-text-head, #coin-text-tail {
    transition: top 0.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s cubic-bezier(0.37, 0, 0.63, 1);
    position: relative;
    left: 0; width: 100%;
    height: 20%;
  }
  #coin-text-head.hidden { top: 2%; }
  #coin-text-tail.hidden { top: 78%; }
  #coin-text-head { top: 0%; }
  #coin-text-tail { top: 80%; }
  #coin-text-head.hidden.other-side { top: -0.5%; }
  #coin-text-tail.hidden.other-side { top: 80.5%; }
  #coin-text-head.hidden.other-side,
  #coin-text-tail.hidden.other-side {
    transition: top 0.5s cubic-bezier(0.5, 0, 0.75, 0), opacity 0.2s cubic-bezier(0.45, 0, 0.55, 1);
  }
  #coin-text-head > *, #coin-text-tail > * {
    position: absolute;
  }
  #coin-text-head > img,
  #coin-text-tail > img {
    left: 5%;
  }
  #scene-game.hflip > #coin-text-head > img,
  #scene-game.hflip > #coin-text-tail > img {
    left: calc(95% - 14.22vh);
  }
  #coin-text-head > div,
  #coin-text-tail > div {
    left: calc(14.22vh + 8%);
  }
  #scene-game.hflip > #coin-text-head > div,
  #scene-game.hflip > #coin-text-tail > div {
    left: 4%;
    text-align: end;
  }
  #coin-flipping { left: calc(67% - 27.5vh); }
  #scene-game.hflip #coin-flipping { left: calc(33% - 27.5vh); }
  </style>
</div>

</div></div>


<script>
const preloadImages = (images, callback) => {
  let count = 0
  for (const name of images) {
    const i = new Image()
    i.onload = () => {
      i.onload = undefined
      count += 1
      callback(count, images.length)
    }
    i.src = name
  }
}
preloadImages([
  'img/coin-head.webp',
  'img/coin-tail.webp',
  'img/coin-small-head.webp',
  'img/coin-small-tail.webp',
], (n) => console.log(n))

const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms))

let pressAnywhereFn = null
const pressAnywhereOnce = (fn) => pressAnywhereFn = fn
const execPressAnywhereFn = () => {
  if (pressAnywhereFn) {
    const fn = pressAnywhereFn
    pressAnywhereFn = null
    fn()
  }
}
document.getElementById('container').addEventListener('click', (e) => execPressAnywhereFn())
window.addEventListener('keydown', (e) => {
  if (e.keyCode === 32) execPressAnywhereFn()
})

document.getElementById('btn-lang').addEventListener('click', (e) => {
  alert('!')
})

const playScene = async (n) => {
  // Reset all elements to hidden state
  document.getElementById('scene-game').classList.add('hidden')
  await delay(1000)
  document.getElementById('coin-text-background-head').classList.add('hidden')
  document.getElementById('coin-text-background-tail').classList.add('hidden')
  document.getElementById('coin-text-head').classList.add('hidden')
  document.getElementById('coin-text-tail').classList.add('hidden')
  document.getElementById('coin-text-head').classList.remove('other-side')
  document.getElementById('coin-text-tail').classList.remove('other-side')
  document.getElementById('coin-flipping').classList.add('hidden')
  if (n % 2 === 0) {
    document.getElementById('scene-game').classList.remove('hflip')
  } else {
    document.getElementById('scene-game').classList.add('hflip')
  }
  document.getElementById('scene-game-illustration').remove()
  const illust = new Image()
  illust.id = 'scene-game-illustration'
  illust.src = 'img/scene-0' + n + '.webp'
  document.getElementById('scene-game').prepend(illust)
  await delay(1000)
  document.getElementById('scene-game').classList.remove('hidden')
  await delay(2000)
  document.getElementById('coin-text-background-head').classList.remove('hidden')
  document.getElementById('coin-text-background-tail').classList.remove('hidden')
  document.getElementById('coin-text-head').classList.remove('hidden')
  document.getElementById('coin-text-tail').classList.remove('hidden')
  await delay(2000)
  document.getElementById('coin-flipping').classList.remove('hidden')

  const coin = document.getElementById('coin-flipping')
  const coinImageH = document.getElementById('coin-flipping-head')
  const coinImageT = document.getElementById('coin-flipping-tail')
  const t0 = Date.now() + (Math.random() < 0.5 ? 1250 : 0)
  const x = (n % 2 === 0) ? 67 : 33
  let stopTime = null
  let stopTimeAtPress = null
  let animationDone = false
  const updateFrame = () => {
    const t1 = Date.now() - t0
    let t = t1
    // If pressed, jump
    if (stopTimeAtPress !== null) {
      const progress = Math.min(1, (t1 - stopTimeAtPress) / 200)
      const y = 21 - 9 * progress * (1 - progress)
      coin.style.top = `${y}vh`
      if (progress === 1) {
        stopTimeAtPress = null  // Stop further processing
      }
    }
    // If pressed, gradually halt
    if (stopTime !== null && t >= stopTime) {
      const target = stopTime + 1250
      if (t1 > stopTime) {
        // f(t) = 1 - exp(-kt) * (a-t)/a  (0 <= t <= a)
        // f'(0) = (1 + ka) / a = 1  =>  k = (a-1) / a
        const a = 2
        const k = 0.5
        const maxT = target - stopTime
        const T = Math.min(a, (t1 - stopTime) / maxT)
        t = stopTime + maxT * (1 - Math.exp(-k * T) * (a - T) / a)
      }
    }

    const ph = Math.sin(t / 2500 * Math.PI * 2)
    const w = Math.abs(ph) * 55
    coin.style.width = `${w}vh`
    coin.style.left = `calc(${x}% - ${w / 2}vh)`
    if (ph >= 0) {
      coinImageH.style.display = 'inline'
      coinImageT.style.display = 'none'
    } else {
      coinImageT.style.display = 'inline'
      coinImageH.style.display = 'none'
    }
    if (!animationDone) requestAnimationFrame(updateFrame)
  }
  updateFrame()

  pressAnywhereOnce(async () => {
    const t = Date.now() - t0
    stopTimeAtPress = t
    stopTime = t - t % 1250 + 1250 + 625
    await delay(stopTime - t + 1500)
    const result = stopTime % 2500
    if (result < 1250) {
      document.getElementById('coin-text-background-head').classList.add('hidden')
      document.getElementById('coin-text-head').classList.add('hidden')
      document.getElementById('coin-text-head').classList.add('other-side')
    } else {
      document.getElementById('coin-text-background-tail').classList.add('hidden')
      document.getElementById('coin-text-tail').classList.add('hidden')
      document.getElementById('coin-text-tail').classList.add('other-side')
    }
    await delay(1000)
    animationDone = true
    await delay(2500)
    playScene(Math.floor(Math.random() * 8 + 1))
  })
}

document.getElementById('btn-start').addEventListener('click', async (e) => {
  document.getElementById('btn-lang').setAttribute('tabindex', '-1')
  document.getElementById('btn-start').setAttribute('tabindex', '-1')
  document.getElementById('btn-start').blur()
  document.getElementById('scene-startup-1').classList.add('hidden')
  document.getElementById('scene-startup-foxnn-logo').classList.add('run')

  let nextHintShown = false
  let networkDone = false
  const next = () => {
    document.getElementById('scene-startup-foxnn-logo').classList.add('hidden')
    document.getElementById('scene-startup-2').classList.add('hidden')
    playScene(Math.floor(Math.random() * 8 + 1))
  }

  ;(async () => {
    await delay(900.0)
    document.getElementById('scene-startup-press').innerText = 'Press screen/Space key'
    networkDone = true
    if (nextHintShown && networkDone) pressAnywhereOnce(next)
  })()

  ;(async () => {
    await delay(2000)
    document.getElementById('scene-startup-2').classList.remove('hidden')
    await delay(500.0)
    document.getElementById('scene-startup-press').classList.remove('hidden')
    nextHintShown = true
    if (nextHintShown && networkDone) pressAnywhereOnce(next)
  })()
})
</script>

</body></html>

