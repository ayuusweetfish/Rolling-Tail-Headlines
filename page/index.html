<!DOCTYPE html>
<html><head>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
  <title>The Rolling Tail Headlines</title>
</head><body>

<style>
/* latin */
@font-face {
  font-family: 'ABeeZee';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(/fonts/esDR31xSG-6AGleN2tWkkJUEGpA.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* latin-ext */
@font-face {
  font-family: 'ABeeZee';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(/fonts/esDR31xSG-6AGleN2tukkJUEGpCeGQ.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'ABeeZee';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: url(/fonts/esDT31xSG-6AGleN2tCUkp8DOJKuGA.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* latin-ext */
@font-face {
  font-family: 'ABeeZee';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: url(/fonts/esDT31xSG-6AGleN2tCUnJ8DOJKuGPLB.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'ChillRoundF';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(/fonts/ChillRoundF.woff2) format('woff2');
}

body {
  margin: 0;
  padding: 0;
  line-height: 1;
  background: #e2d3bb;
  color: black;
}

#container {
  margin: 0 auto;
  height: 100vh;
  width: 100%;
  max-width: 111.11vh;
  position: relative;
  background: #fef4e4;
  overflow: hidden;

  font-family: 'ABeeZee', 'ChillRoundF', sans-serif;
  line-height: 1;
}

html {
  font-size: min(1vw, 1.111vh);
}
/* Main viewport width = min(100vw, 111.11vh) */


#container > div > * {
  position: absolute;
}

#container > div {
  transition: opacity 0.2s ease;
}

.lang-hidden {
  display: none !important;
}

.maybe-hidden {
  transition: opacity 0.2s ease;
}
.hidden {
  opacity: 0 !important;
  pointer-events: none;
  cursor: auto;
}

p {
  margin: 0;
  padding: 0;
}

button, select {
  cursor: pointer;
  border: none;
  background: none;
  margin: 0;
  padding: 0;
  color: transparent;
}
</style>

<div id='container'>

<div>
  <div id='scene-startup-foxnn-logo'>
    <img src='img/fox-nn.webp' style='width: 100%; position: absolute; left: 0'>
  </div>
  <style>
  @keyframes pop {
    0%, 90%, 100% {
      left: 0;
    }
    95% {
      left: -1.2vh;
    }
  }
  #scene-startup-foxnn-logo {
    width: max(60%, 50vh);
    left: calc(97% - calc(max(60%, 50vh) / 2));
    top: 10%;
    transition: left 1.5s ease, top 1.5s ease, opacity 0.2s ease;
  }
  #scene-startup-foxnn-logo > img {
    transform: rotate(90deg);
    transition: transform 1.5s ease;
    animation: pop 10s infinite;
  }
  #btn-start {
    width: max(60%, 50vh); height: clamp(50vh, 60vw, 66.67vh);
    left: calc(97% - calc(max(60%, 50vh) / 2)); top: 10%;
  }
  #scene-startup-foxnn-logo.run {
    left: 0%;
    /* size is max(min(100vw, 111.11vh) * 60%, 50vh) = clamp(50vh, 60vw, 66.67vh) */
    top: calc(32.5vh - clamp(25vh, 30vw, 33.33vh));
  }
  #scene-startup-foxnn-logo.run > img {
    transform: rotate(0deg) scale(0.75);
    animation: none;
  }
  #game-title {
    left: 5%;
    top: calc(40% - 25rem);
    font-size: 9.451em;
    line-height: 1.5;
  }
  #rolling-sp-tail { display: inline; }
  #rolling-br-tail { display: none; }
  @media (max-aspect-ratio: 3/4) {
    /* Compensate with transform */
    #scene-startup-foxnn-logo {
      width: 60vw;
      left: 67vw;
      top: calc(35% - 30vw);
    }
    #scene-startup-foxnn-logo > img {
      transform: rotate(90deg) scale(1.5)
    }
    #btn-start {
      left: 52vw;
      top: calc(35% - 45vw);
      width: 90vw; height: 90vw;
    }
    #scene-startup-foxnn-logo.run {
      left: 20%;
      top: calc(50vh - 60vw);
    }
    #scene-startup-foxnn-logo.run > img {
      transform: rotate(0deg) scale(1);
    }
    #game-title {
      top: calc(40% - 45vw);
      font-size: 12vw;
    }
    #rolling-sp-tail { display: none; }
    #rolling-br-tail { display: inline-block; }
  }
  </style>
</div>
<div id='scene-startup-1'>
  <p id='game-title'>The<br>Rolling<span id='rolling-sp-tail'> </span><br id='rolling-br-tail'>Tail<br>Headlines</p>
  <button style='border-radius: 50%; transform: scale(1.1); z-index: 99' id='btn-start'></button>

  <!-- In portrait screens, 60vw = 1200px in logo -> 256px in pen = 12.8vw. Scale at 1.5 -->
  <img src='img/pen.webp' style='height: min(14.22vh, 19.2vw); left: 5.6%; top: 66.7%'>
  <p style='left: calc(7% + min(14.22vh, 19.2vw)); top: 67.2%; font-size: min(7.2vh, 9.722vw)' id='lang-name'></p>
  <p style='left: calc(7% + min(14.22vh, 19.2vw)); top: calc(67.2vh + min(8.5vh, 11.477vw)); font-size: min(4.8vh, 6.481vw); opacity: 0.5' id='lang-code'></p>
  <select style='left: calc(7% + 14.22vh); top: 67.2%; width: 60vh; height: 13%' id='btn-lang'>
    <optgroup label='Main languages'>
      <option value='en'>English (en)</option>
      <option value='zh-Hans'>简体中文 (zh-Hans)</option>
      <option value='zh-Hant'>正體中文 (zh-Hant)</option>
    </optgroup>
    <optgroup label='Untested languages (instructions will be in English)'>
      <option value='hi'>हिन्दी (hi)</option>
      <option value='es'>Español (es)</option>
      <option value='ar'>اَلْعَرَبِيَّةُ (ar)</option>
      <option value='fr'>Français (fr)</option>
      <option value='bn'>বাংলা (bn)</option>
      <option value='pt'>Português (pt)</option>
      <option value='ru'>Русский (ru)</option>
      <option value='ur'>اُردُو (ur)</option>
      <option value='id'>Bahasa Indonesia (id)</option>
      <option value='de'>Deutsch (de)</option>
      <option value='ja'>日本語 (ja)</option>
      <option value='pcm'>Naijá (pcm)</option>
      <option value='mr'>मराठी (mr)</option>
      <option value='te'>తెలుగు (te)</option>
      <option value='tr'>Türkçe (tr)</option>
      <option value='ha'>Harshen Hausa (ha)</option>
      <option value='ta'>தமிழ் (ta)</option>
      <option value='sw'>Kiswahili (sw)</option>
      <option value='vi'>Tiếng Việt (vi)</option>
      <option value='tl'>Wikang Tagalog (tl)</option>
      <option value='pa'>پنجابی (pa)</option>
      <option value='ko'>한국어 (ko)</option>
      <option value='fa'>فارسی (fa)</option>
      <option value='jv'>Basa Jawa (jv)</option>
      <option value='it'>Italiano (it)</option>
      <option value='po'>Polski (po)</option>
      <option value='hu'>Magyar nyelv (hu)</option>
    </optgroup>
  </select>
</div>
<div id='scene-startup-2' class='hidden'>
  <style>
  #fox-nn-catchphrase {
    left: 57%; width: 40%; top: 12.5%; height: 40%;
    font-size: 5.6em; display: table;
  }
  #fox-nn-intro {
    left: 5%; width: 90%; top: 62%;
    font-size: 4.8em; line-height: 1.5;
  }
  @media (max-aspect-ratio: 3/4) {
    #fox-nn-catchphrase {
      left: 5%; width: 90%; top: 53%; height: 100%;
      display: block;
    }
    #fox-nn-intro {
      top: calc(53% + 20vw);
    }
  }
  </style>
  <div id='fox-nn-catchphrase'><p style='display: table-cell; vertical-align: middle; line-height: 1.5'><span data-lang='default'>In the 22<sup>nd</sup> century, foxes are the playful super-wizards.</span><span data-lang='zh-Hans'>在 22 世纪，狐狸是最最古灵精怪的超级魔法师。</span><span data-lang='zh-Hant'>在 22 世紀，狐狸是最最古靈精怪的超級魔法師。</span></p></div>
  <p id='fox-nn-intro'><span data-lang='default'>Fox Newroll Network takes you around the world with our one-of-a-kind fox magic of “heads or tails”. Join us in our exploration!</span><span data-lang='zh-Hans'>狐研新闻社（FoxNN）用独一无二的“狐头狐尾”魔法，带你环游世界。加入我们的探索之旅吧！</span><span data-lang='zh-Hant'>狐研新聞社（FoxNN）用獨一無二的“狐頭狐尾”魔法，帶你環遊世界。加入我們的探索之旅吧！</span></p>
  <p style='left: 5%; width: 90%; top: 88%; font-size: 4.8em; line-height: 1.5; opacity: 0.5' id='scene-startup-press' class='maybe-hidden hidden'>
    <span id='text-loading'><span data-lang='default'>Loading…</span><span data-lang='zh-Hans'>载入中……</span><span data-lang='zh-Hant'>載入中……</span></span><!--
    --><span id='text-press-to-continue' style='display: none'><span data-lang='default'>Press screen/Space key</span><span data-lang='zh-Hans'>点按屏幕/按空格键继续</span><span data-lang='zh-Hant'>點按螢幕/按空格鍵繼續</span></span>
  </p>
</div>


<div id='scene-game' class='hidden' style='transition: opacity 0.5s ease'>
  <img src='' id='scene-game-illustration'>
  <div style='background: linear-gradient(#fef4e4 80%, transparent 100%); height: 20%; width: 100%; top: 0; left: 0; transition: opacity 0.5s ease; opacity: 0.75' id='coin-text-background-head'></div>
  <div style='background: linear-gradient(transparent 0%, #fef4e4 20%); height: 20%; width: 100%; top: 80%; left: 0; transition: opacity 0.5s ease; opacity: 0.75' id='coin-text-background-tail'></div>
  <div id='coin-text-head'>
    <img src='img/coin-small-head.webp' style='height: 12.798em; top: 5vh'>
    <div style='font-size: 5.4em; top: 5vh; width: calc(88vw - 12.798rem); height: 12.798rem; display: table'><p style='display: table-cell; vertical-align: middle' id='coin-text-content-head'>A</p></div>
  </div>
  <div id='coin-text-tail'>
    <img src='img/coin-small-tail.webp' style='height: 12.798rem; top: calc(15vh - 12.798rem)'>
    <div style='font-size: 5.4em; top: calc(15vh - 12.798rem); width: calc(88vw - 12.798rem); height: 12.798rem; display: table'><p style='display: table-cell; vertical-align: middle' id='coin-text-content-tail'>B</p></div>
  </div>
  <div style='width: 55vh; height: 55vh; top: 21vh; border-radius: 50%; border: black 1vh solid; transition: opacity 0.5s ease; background: #fef4e4' id='coin-flipping'>
    <img style='width: 100%; height: 100%' src='img/coin-head.webp' id='coin-flipping-head'>
    <img style='width: 100%; height: 100%' src='img/coin-tail.webp' id='coin-flipping-tail'>
  </div>
  <style>
  #scene-game-illustration {
    width: 100%; height: 100%; left: 0; top: 0; transition: opacity 0.5s ease;
    object-fit: cover;
    object-position: center;
  }
  @media (max-aspect-ratio: 3/4) {
    #scene-game #scene-game-illustration { object-position: 0 0; }
    #scene-game.hflip #scene-game-illustration { object-position: 80% 0; }
  }
  #coin-text-head, #coin-text-tail {
    transition: top 0.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s cubic-bezier(0.37, 0, 0.63, 1);
    position: relative;
    left: 0; width: 100%;
    height: 20%;
  }
  #coin-text-head.hidden { top: 2%; }
  #coin-text-tail.hidden { top: 78%; }
  #coin-text-head { top: 0%; }
  #coin-text-tail { top: 80%; }
  #coin-text-head.hidden.other-side { top: -0.5%; }
  #coin-text-tail.hidden.other-side { top: 80.5%; }
  #coin-text-head.hidden.other-side,
  #coin-text-tail.hidden.other-side {
    transition: top 0.5s cubic-bezier(0.5, 0, 0.75, 0), opacity 0.2s cubic-bezier(0.45, 0, 0.55, 1);
  }
  #coin-text-head > *, #coin-text-tail > * {
    position: absolute;
  }
  #coin-text-head > img,
  #coin-text-tail > img {
    left: 5%;
  }
  #scene-game.hflip > #coin-text-head > img,
  #scene-game.hflip > #coin-text-tail > img {
    left: calc(95% - 12.798rem);
  }
  #coin-text-head > div,
  #coin-text-tail > div {
    left: calc(12.798rem + 8%);
  }
  #scene-game.hflip > #coin-text-head > div,
  #scene-game.hflip > #coin-text-tail > div {
    left: 4%;
    text-align: end;
  }
  #coin-flipping { left: calc(67% - 27.5vh); }
  #scene-game.hflip #coin-flipping { left: calc(33% - 27.5vh); }
  </style>
</div>


<div id='scene-newspaper' class='hidden' style='transition: opacity 0.5s ease'>
<style>
#scene-newspaper {
  height: 100%;
  overflow: scroll;
}
#newspaper-container {
  padding: 10em 4em;
  position: static !important;
}
#newspaper-container.unfinished {
  padding-bottom: 0;
}
#newspaper-container.unfinished .newspaper-page:last-child() {
  margin-bottom: 0;
}
#newspaper-container p,
#newspaper-container ul,
#newspaper-container ol {
  font-size: 4rem;
}
#newspaper-container p {
  line-height: 1.5;
  margin: 1ex 0;
}
#newspaper-container h1,
#newspaper-container h2,
#newspaper-container h3,
#newspaper-container h4,
#newspaper-container h5,
#newspaper-container li {
  line-height: 1.5;
  margin: 1.5ex 0 0.75ex;
}
#newspaper-container h1 { font-size: 8em; margin-bottom: 1ex; }
#newspaper-container h2 { font-size: 6em; }
#newspaper-container h3 { font-size: 5.5em; }
#newspaper-container h4 { font-size: 5em; }
#newspaper-container h5 { font-size: 4.5em; }
#newspaper-container h6 { font-size: 4em; }
#newspaper-container hr {
  border: none;
  border-top: 0.5em rgba(128, 128, 128, 50%) solid;
  margin: 2ex 0;
}
#newspaper-container hr.header-end {
  border-top: 0.5em black solid;
  margin-bottom: 3em;
}
#newspaper-container a {
  color: #864;
  font-size: 4em;
}
.newspaper-page {
  border-top: 1em black solid;
  padding: 1ex 0;
  margin: 10vh 0;
}
.newspaper-page-num {
  text-align: end;
  opacity: 0.5;
  font-size: 9em !important;
  font-weight: bold;
  margin: 0.25ex 0 -2ex !important;
  line-height: 1 !important;
}
.newspaper-page-num + * {
  width: calc(100% - 7.5rem);
}
.newspaper-page .page-illust {
  width: 50em;
  margin: 2vh 0;
}
.newspaper-page .page-illust.page-illust-left {
  float: left;
  margin-right: 4em;
}
.newspaper-page .page-illust.page-illust-right {
  float: right;
  margin-left: 4em;
}
  margin-left: 4em;
</style>

<div id='newspaper-container'>
  <div id='newspaper-header' style='text-align: center'>
    <img src='img/fox-nn.webp' style='width: min(90%, 55vh); display: inline-block; margin-top: 5vh'>
    <h1 style='font-size: 7.75em; line-height: 1; margin: 1ex 0 0.7ex'><span data-lang='default'>The Rolling Tail Gazette</span><span data-lang='zh-Hans' style='letter-spacing: 0.1em'>— 九尾日报 —</span><span data-lang='zh-Hant' style='letter-spacing: 0.1em'>— 九尾日報 —</span></h1>
    <p style='margin: 0 0 2ex'>
      <i><span data-lang='default'>22<sup>nd</sup> Century Ed.</span><span data-lang='zh-Hans'>22 世纪版</span><span data-lang='zh-Hant'>22 世紀版</span></i>
      <span style='opacity: 0.1'>|</span>
      <i><span data-lang='default'>Issue </span><span data-lang='zh-Hans'>第 </span><span data-lang='zh-Hant'>第 </span><span id='newspaper-issue-num'></span><span><span data-lang='zh-Hans'> 期</span><span data-lang='zh-Hant'> 期</span></span></i>
      <span style='opacity: 0.1'>|</span>
      <i><span data-lang='default'>Fox Newroll Network</span><span data-lang='zh-Hans'>狐研新闻社</span><span data-lang='zh-Hant'>狐研新聞社</span></i>
    </p>
    <hr class='header-end'>
  </div>
  <div id='newspaper-permalink'>
    <a href='#' target='_blank'><span data-lang='default'>Permalink</span><span data-lang='zh-Hans'>固定链接</span><span data-lang='zh-Hant'>固定連結</span></a>
  </div>
</div>
</div>

</div>


<script>
// Polyfill
Array.prototype.at = Array.prototype.at || function (index) {
  return this[index < 0 ? (index + this.length) : index]
}
</script>
<script src='/ext/marked.min.js'></script>
<script src='/ext/purify.min.js'></script>
<script>
const api = window.location.origin
let gameHandle = null   // { uuid, topics: [[string; 2]; 3] }

const preloadImages = (images, callback) => {
  let count = 0
  for (const name of images) {
    const i = new Image()
    i.onload = () => {
      i.onload = undefined
      count += 1
      callback(count, images.length)
    }
    i.src = name
  }
}
preloadImages([
  'img/coin-head.webp',
  'img/coin-tail.webp',
  'img/coin-small-head.webp',
  'img/coin-small-tail.webp',
], (n) => console.log(n))

document.addEventListener('DOMContentLoaded', (e) => {

const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms))

let pressAnywhereFn = null
const pressAnywhereOnce = (fn) => pressAnywhereFn = fn
const execPressAnywhereFn = () => {
  if (pressAnywhereFn) {
    const fn = pressAnywhereFn
    pressAnywhereFn = null
    fn()
  }
}
document.getElementById('container').addEventListener('mousedown', (e) => execPressAnywhereFn())
document.getElementById('container').addEventListener('touchstart', (e) => execPressAnywhereFn())
window.addEventListener('keydown', (e) => {
  if (e.keyCode === 32) execPressAnywhereFn()
})

const langSelectEl = document.getElementById('btn-lang')
// Negotiate a language
const negotiateLang = (accept, supported) => {
  let bestScore = accept.length + supported.length
  let bestLang = supported[0]
  for (const l of supported) {
    for (const [j, la] of Object.entries(accept)) {
      if (la.substring(0, 2) === l.substring(0, 2)) {
        const score = j + (l === la ? 0.5 : 0)
        if (score < bestScore)
          [bestScore, bestLang] = [score, l]
      }
    }
  }
  return bestLang
}
const supportedLanguages = []
for (const o of langSelectEl.options) supportedLanguages.push(o.value)
const bestLang = negotiateLang(navigator.languages, supportedLanguages)
langSelectEl.value = bestLang

const updateLangDisplay = () => {
  const optionCode = langSelectEl.value
  const optionText = langSelectEl.options[langSelectEl.selectedIndex].text
  document.getElementById('lang-name').innerText = optionText.substring(0, optionText.lastIndexOf(' '))
  document.getElementById('lang-code').innerText = optionCode
}
updateLangDisplay()
langSelectEl.addEventListener('change', (e) => updateLangDisplay())

const updateTranslations = (parentEl, lang) => {
  const els = parentEl.querySelectorAll('[data-lang]')
  let lastParent = null
  let siblings = []
  const process = (siblings) => {
    // Hide all elements in `siblings` that does not match the language
    let defaultElement = null
    let matched = false
    for (const el of siblings)
      if (el.dataset.lang === lang) {
        matched = true
        el.classList.remove('lang-hidden')
      } else {
        el.classList.add('lang-hidden')
        if (el.dataset.lang === 'default')
          defaultElement = el
      }
    if (!matched && defaultElement)
      defaultElement.classList.remove('lang-hidden')
  }
  for (const el of els) {
    if (el.parentNode !== lastParent) {
      process(siblings)
      lastParent = el.parentNode
      siblings = []
    }
    siblings.push(el)
  }
  process(siblings)
}

// Audio
// Using two overlapping instances did not result in seamless loop
// and also increased network traffic. Give up and revert to simple looping T-T
const audioBackground = new Audio('aud/tails-up.mp3')
audioBackground.volume = 0.5
audioBackground.addEventListener('timeupdate', (e) => {
  const totalDur = 4 * 60 / (132 / 60)
  if (audioBackground.currentTime >= totalDur) {
    audioBackground.pause()
    audioBackground.currentTime -= totalDur
    audioBackground.play()
  }
})
const soundEffects = {}
for (const name of ['newspaper', 'coin']) {
  soundEffects[name] = new Audio(`aud/${name}.mp3`)
}
const playSfx = (name) => {
  soundEffects[name].currentTime = 0
  soundEffects[name].play()
}

const header = document.getElementById('newspaper-header')
header.remove()
const permalinkTempl = document.getElementById('newspaper-permalink')
permalinkTempl.remove()
let newspaperImagesDone = []  // Updated by `playNewspaper`
let newspaperImages = []  // Filled by this function, `parseNewspaper`, in case of enlengthened blockage
const parseNewspaper = (issueNum, s) => {
  const container = document.getElementById('newspaper-container')
  container.replaceChildren()

  const pages = s.split('~~++ page separator ++~~')
  let pageNum = 0
  for (const page of pages) {
    pageNum++
    const html = DOMPurify.sanitize(marked.parse(page))
    const pageEl = document.createElement('div')
    pageEl.classList.add('newspaper-page')
    pageEl.innerHTML = html
    container.append(pageEl)

    // Illustration
    if (pageNum > 1) {
      const illustEl = document.createElement('img')
      illustEl.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=' // 1-pixel transparent PNG
      illustEl.classList.add('page-illust')
      if ((issueNum + pageNum) % 2 === 0) {
        illustEl.classList.add('page-illust-left')
      } else {
        illustEl.classList.add('page-illust-right')
      }
      if (pageEl.children.length > 2) {
        pageEl.insertBefore(illustEl, pageEl.children[2])
      }
      // Confirm completion before setting source
      if (newspaperImagesDone[pageNum - 2])
        illustEl.src = `issue/${issueNum}/illust/${pageNum - 1}`
      else
        newspaperImages[pageNum - 2] = illustEl
    }

    // Page number
    if (pageNum === 1) {
      pageEl.prepend(header.cloneNode(/* deep: */ true))
      document.getElementById('newspaper-issue-num').innerText = issueNum.toString()
    } else {
      const pageNumEl = document.createElement('p')
      pageNumEl.classList.add('newspaper-page-num')
      pageNumEl.innerText = pageNum.toString()
      pageEl.prepend(pageNumEl)
    }
  }
}

let newspaperAtBottom = true
let lastAtBottomTrue = 0
const sceneNewspaper = document.getElementById('scene-newspaper')
const newspaperContainer = document.getElementById('newspaper-container')
sceneNewspaper.addEventListener('wheel', (e) => {
  const H = sceneNewspaper.clientHeight
  const h = newspaperContainer.clientHeight
  const currentAtBottom = (sceneNewspaper.scrollTop >= h - H * 1.2)
  if (!currentAtBottom && lastAtBottomTrue < Date.now() - 500) {
    newspaperAtBottom = false
  } else if (currentAtBottom) {
    newspaperAtBottom = true
    lastAtBottomTrue = Date.now()
  }
})
const playNewspaper = async (issueNum, autoScroll) => {
  const scene = document.getElementById('scene-newspaper')
  const container = document.getElementById('newspaper-container')
  container.classList.add('unfinished')

  const lang = await (await fetch(`${api}/issue/${issueNum}/lang`)).text()
  updateTranslations(header, lang)
  updateTranslations(permalinkTempl, lang)

  parseNewspaper(issueNum, '')

  for (let i = 0; i < 3; i++) {
    ;(async () => {
      while (true) {
        const text = await (await fetch(`${api}/issue/${issueNum}/illust/${i + 1}/done`)).text()
        if (parseInt(text) === 1) break
        await delay(1000)
      }
      newspaperImagesDone[i] = true
      if (newspaperImages[i])
        newspaperImages[i].src = `issue/${issueNum}/illust/${i + 1}`
    })()
  }

  const reader = (await fetch(`${api}/issue/${issueNum}/raw`)).body.getReader()
  const chunks = []
  while (true) {
    const { done, value: chunk } = await reader.read()
    if (done) { break }
    chunks.push((new TextDecoder()).decode(chunk))
    parseNewspaper(issueNum, chunks.join(''))
    if (autoScroll && newspaperAtBottom)
      scene.scrollTo({
        top: container.clientHeight - scene.clientHeight,
        left: 0,
        behavior: 'smooth',
      })
  }

  // Link
  const linkEl = permalinkTempl.cloneNode(/* deep: */ true)
  linkEl.querySelector('a').href = `/${issueNum}`
  container.appendChild(linkEl)

  container.classList.remove('unfinished')
  if (autoScroll && newspaperAtBottom)
    scene.scrollTo({
      top: container.clientHeight - scene.clientHeight,
      left: 0,
      behavior: 'smooth',
    })
}

// Returns an integer in [0, range), seeded by `str`
const randomWithSeed = (range, str) => {
  // Fx Hash with Firefox secret power ^ ^
  // https://github.com/cbreeden/fxhash/blob/a03cbf4/lib.rs#L70
  // Assumes little endian
  const fxHash32 = (data) => {
    const ROTATE = 5
    const SEED32 = 0x9e3779b9
    const rotl32 = (x, r) => ((x << r) | (x >>> (32 - r))) >>> 0

    let hash = 0
    const n = data.length
    let i = 0
    for (; i + 4 < n; i += 4) {
      const word = data[i] | (data[i + 1] << 8) | (data[i + 2] << 16) | (data[i + 3] << 24)
      hash = Math.imul(rotl32(hash, ROTATE) ^ word, SEED32)
    }
    if (i + 2 < n) {
      const word = data[i] | (data[i + 1] << 8)
      hash = Math.imul(rotl32(hash, ROTATE) ^ word, SEED32)
      i += 2
    }
    if (i + 1 < n) {
      hash = Math.imul(rotl32(hash, ROTATE) ^ data[i], SEED32)
    }

    return hash >>> 0
  }
  return (fxHash32((new TextEncoder()).encode(str)) >>> 7) % range
}
const illustNums = [] // Initialised at start-game request
const playScene = async (index) => {
  // Reset all elements to hidden state
  document.getElementById('scene-game').classList.add('hidden')
  await delay(1000)
  document.getElementById('coin-text-background-head').classList.add('hidden')
  document.getElementById('coin-text-background-tail').classList.add('hidden')
  document.getElementById('coin-text-head').classList.add('hidden')
  document.getElementById('coin-text-tail').classList.add('hidden')
  document.getElementById('coin-text-head').classList.remove('other-side')
  document.getElementById('coin-text-tail').classList.remove('other-side')
  document.getElementById('coin-text-content-head').innerText = gameHandle.topics[index * 2 + 0] + '…'
  document.getElementById('coin-text-content-tail').innerText = gameHandle.topics[index * 2 + 1] + '…'
  document.getElementById('coin-flipping').classList.add('hidden')
  const illustNum = illustNums[index]
  if (illustNum % 2 === 0) {
    document.getElementById('scene-game').classList.remove('hflip')
  } else {
    document.getElementById('scene-game').classList.add('hflip')
  }
  document.getElementById('scene-game-illustration').remove()
  const illust = new Image()
  illust.id = 'scene-game-illustration'
  illust.src = `img/scene-0${illustNum}.webp`
  document.getElementById('scene-game').prepend(illust)
  await delay(1000)
  document.getElementById('scene-game').classList.remove('hidden')
  await delay(2000)
  document.getElementById('coin-text-background-head').classList.remove('hidden')
  document.getElementById('coin-text-background-tail').classList.remove('hidden')
  document.getElementById('coin-text-head').classList.remove('hidden')
  document.getElementById('coin-text-tail').classList.remove('hidden')
  await delay(2000)
  document.getElementById('coin-flipping').classList.remove('hidden')

  const coin = document.getElementById('coin-flipping')
  const coinImageH = document.getElementById('coin-flipping-head')
  const coinImageT = document.getElementById('coin-flipping-tail')
  const t0 = Date.now() -
    (randomWithSeed(2, gameHandle.topics[index * 2 + 1] + '\\' + gameHandle.topics[index * 2]) ?
     1250 : 0)
  const x = (illustNum % 2 === 0) ? 67 : 33
  let stopTime = null
  let stopTimeAtPress = null
  let animationDone = false
  const updateFrame = () => {
    const t1 = Date.now() - t0
    let t = t1
    // If pressed, jump
    if (stopTimeAtPress !== null) {
      const progress = Math.min(1, (t1 - stopTimeAtPress) / 200)
      const y = 21 - 9 * progress * (1 - progress)
      coin.style.top = `${y}vh`
      if (progress === 1) {
        stopTimeAtPress = null  // Stop further processing
      }
    }
    // If pressed, gradually halt
    if (stopTime !== null && t >= stopTime) {
      const target = stopTime + 1250
      if (t1 > stopTime) {
        // f(t) = 1 - exp(-kt) * (a-t)/a  (0 <= t <= a)
        // f'(0) = (1 + ka) / a = 1  =>  k = (a-1) / a
        const a = 2
        const k = 0.5
        const maxT = target - stopTime
        const T = Math.min(a, (t1 - stopTime) / maxT)
        t = stopTime + maxT * (1 - Math.exp(-k * T) * (a - T) / a)
      }
    }

    const ph = Math.sin(t / 2500 * Math.PI * 2)
    const w = Math.abs(ph) * 55
    coin.style.width = `${w}vh`
    coin.style.left = `calc(${x}% - ${w / 2}vh)`
    if (ph >= 0) {
      coinImageH.style.display = 'inline'
      coinImageT.style.display = 'none'
    } else {
      coinImageT.style.display = 'inline'
      coinImageH.style.display = 'none'
    }
    if (!animationDone) requestAnimationFrame(updateFrame)
  }
  updateFrame()

  pressAnywhereOnce(async () => {
    const t = Date.now() - t0
    stopTimeAtPress = t
    stopTime = t - t % 1250 + 1250 + 625

    playSfx('coin')

    const side = (stopTime % 2500 < 1250) ? 1 : 0 // 0 - head; 1 - tail
    const flipResponse /* Promise<string> */ = (await fetch(`${api}/flip`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `uuid=${gameHandle.uuid}&sel=${index * 2 + side}`
    })).text()

    await delay(stopTime - t + 1500)
    if (side === 0) {
      document.getElementById('coin-text-background-tail').classList.add('hidden')
      document.getElementById('coin-text-tail').classList.add('hidden')
      document.getElementById('coin-text-tail').classList.add('other-side')
    } else {
      document.getElementById('coin-text-background-head').classList.add('hidden')
      document.getElementById('coin-text-head').classList.add('hidden')
      document.getElementById('coin-text-head').classList.add('other-side')
    }
    await delay(1000)
    animationDone = true
    await delay(2500)
    if (index === 2) {
      document.getElementById('scene-game').classList.add('hidden')
      await delay(1000)
      const issueNum = parseInt(await flipResponse)
      playSfx('newspaper')
      playNewspaper(issueNum, /* playNewspaper */ true)
      document.getElementById('scene-newspaper').classList.remove('hidden')
    } else {
      playScene(index + 1)
    }
  })
}

document.getElementById('btn-start').addEventListener('click', async (e) => {
  document.getElementById('btn-lang').setAttribute('tabindex', '-1')
  document.getElementById('btn-start').setAttribute('tabindex', '-1')
  document.getElementById('btn-start').blur()
  document.getElementById('scene-startup-1').classList.add('hidden')
  document.getElementById('scene-startup-foxnn-logo').classList.add('run')

  updateTranslations(document, langSelectEl.value)
  updateTranslations(header, langSelectEl.value)

  let nextHintShown = false
  let networkDone = false
  const next = () => {
    document.getElementById('scene-startup-foxnn-logo').classList.add('hidden')
    document.getElementById('scene-startup-2').classList.add('hidden')
    // Sample 3 non-duplicating illustrations
    const illustNumPool = [1, 2, 3, 4, 5, 6, 7, 8]
    for (let i = 0; i < 3; i++) {
      const p = randomWithSeed(illustNumPool.length,
        gameHandle.topics[i * 2] + '/' + gameHandle.topics[i * 2 + 1])
      illustNums[i] = illustNumPool[p]
      const t = illustNumPool.pop()
      if (p !== illustNumPool.length - 1) illustNumPool[p] = t
    }
    playScene(0)
  }

  ;(async () => {
    gameHandle = await (await fetch(`${api}/start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `lang=${langSelectEl.value}`
    })).json()
    document.getElementById('text-loading').style.display = 'none'
    document.getElementById('text-press-to-continue').style.display = 'inline'
    networkDone = true
    if (nextHintShown && networkDone) pressAnywhereOnce(next)
  })()

  ;(async () => {
    await delay(2000)
    document.getElementById('scene-startup-2').classList.remove('hidden')
    await delay(3000)
    document.getElementById('scene-startup-press').classList.remove('hidden')
    nextHintShown = true
    if (nextHintShown && networkDone) pressAnywhereOnce(next)
  })()
})

const playPermalink = async (issueNum) => {
  document.getElementById('scene-startup-foxnn-logo').remove()
  document.getElementById('scene-startup-1').remove()
  document.getElementById('scene-startup-2').remove()
  document.getElementById('scene-game').remove()
  await playNewspaper(issueNum)
  document.getElementById('scene-newspaper').classList.remove('hidden')
}
const pathMatch = new URL(window.location.href).pathname.match(/\/([0-9]+)$/)
if (pathMatch) {
  playPermalink(parseInt(pathMatch[1], 10))
} else {
  // Play background track only during play
  pressAnywhereOnce(() => {
    audioBackground.play()
    // Some browsers (e.g. Firefox Android) takes touch-end/click (rather than touch-start)
    // as the start of interaction required to auto-play. So repeatedly check.
    const tryPlay = () => {
      audioBackground.play()
      if (audioBackground.paused) setTimeout(tryPlay, 200)
    }
    setTimeout(tryPlay, 200)
  })
}

})
</script>

</body></html>
